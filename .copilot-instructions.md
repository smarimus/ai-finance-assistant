# AI Finance Assistant - GitHub Copilot Context

## Project Overview
This is a sophisticated multi-agent AI system for financial education and portfolio management built with Python, LangChain, LangGraph, and Streamlit. The system uses specialized agents to handle different aspects of financial assistance.

## Architecture & Core Patterns

### Agent System Architecture
```python
# All agents inherit from BaseFinanceAgent
class BaseFinanceAgent(ABC):
    def __init__(self, llm: LLM, tools: List[BaseTool], agent_name: str, system_prompt: str)
    
    @abstractmethod
    def execute(self, state: FinanceAssistantState) -> Dict[str, Any]:
        """Returns: agent_response, sources, confidence, next_agent, updated_context"""
```

### Agent Response Format
All agents return responses in this standardized format:
```python
{
    "agent_response": str,      # The formatted response text
    "sources": List[str],       # Source citations for information
    "confidence": float,        # Response confidence score (0.0-1.0)
    "next_agent": Optional[str], # Suggested next agent to handle follow-up
    "updated_context": Dict     # Updated context information
}
```

### State Management
```python
# Use TypedDict for LangGraph state management
class FinanceAssistantState(TypedDict):
    query: str
    context: Dict[str, Any]
    agent_responses: List[Dict[str, Any]]
    current_agent: str
    conversation_history: List[Dict[str, Any]]
```

## Project Structure

```
src/
├── agents/               # Specialized financial agents
│   ├── base_agent.py    # Abstract base class for all agents
│   ├── finance_qa_agent.py    # Educational Q&A (FinanceQAAgent)
│   ├── portfolio_agent.py     # Portfolio analysis (PortfolioAnalysisAgent)
│   ├── market_agent.py        # Market data & analysis (MarketAnalysisAgent)
│   └── goal_agent.py          # Goal planning (GoalPlanningAgent)
├── core/                # Core system components
│   ├── config.py        # Configuration management
│   ├── state.py         # State definitions for LangGraph
│   └── workflow.py      # LangGraph workflow orchestration
├── rag/                 # Retrieval-Augmented Generation
│   ├── vector_store.py  # FAISS vector database
│   ├── retriever.py     # Document retrieval logic
│   └── embeddings.py    # OpenAI embeddings integration
├── data/               # Data management
│   ├── market_data.py  # Alpha Vantage API integration
│   └── knowledge_base/ # Financial education documents
├── utils/              # Utility functions
│   ├── portfolio_calc.py # PortfolioCalculator, FinancialCalculator
│   └── helpers.py      # General utility functions
└── web_app/           # Streamlit web interface
    ├── main.py        # Main Streamlit application
    ├── chat_tab.py    # Chat interface
    ├── portfolio_tab.py # Portfolio analysis UI
    ├── market_tab.py  # Market data UI
    └── goals_tab.py   # Goal planning UI
```

## Agent Specializations

### FinanceQAAgent
- **Purpose**: Financial education and basic Q&A
- **Capabilities**: Explains financial concepts, answers educational questions
- **Tools**: RAG retrieval from knowledge base
- **Example queries**: "What is diversification?", "How do bonds work?"

### PortfolioAnalysisAgent  
- **Purpose**: Portfolio analysis and recommendations
- **Capabilities**: Calculates metrics, analyzes allocation, provides recommendations
- **Tools**: PortfolioCalculator, portfolio visualization
- **Example queries**: "Analyze my portfolio", "Calculate my portfolio risk"

### MarketAnalysisAgent
- **Purpose**: Real-time market data and analysis
- **Capabilities**: Fetches market data, analyzes trends, provides market insights
- **Tools**: Alpha Vantage API, market data caching
- **Example queries**: "What's AAPL's performance today?", "Market trends analysis"

### GoalPlanningAgent
- **Purpose**: Financial goal setting and planning
- **Capabilities**: Goal calculations, savings plans, retirement planning
- **Tools**: FinancialCalculator, goal tracking
- **Example queries**: "Plan for retirement", "How much to save for house?"

## Key Dependencies & Versions

```python
# Core AI/ML
langchain = "^0.1.0"        # LLM orchestration
langgraph = "^0.0.26"       # Workflow management  
openai = "^1.12.0"          # GPT-4 integration

# Vector Database
faiss-cpu = "^1.7.4"        # Vector similarity search
sentence-transformers = "^2.2.2"  # Embeddings

# Data & Market
yfinance = "^0.2.12"        # Market data backup
alpha-vantage = "^2.3.1"    # Primary market data API
pandas = "^2.1.4"           # Data manipulation

# Web Interface  
streamlit = "^1.31.0"       # Web application framework
plotly = "^5.17.0"          # Interactive charts
```

## Configuration Patterns

### Environment Variables (.env)
```bash
OPENAI_API_KEY=your_openai_api_key_here
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_api_key_here
DEBUG=True
MODEL_NAME=gpt-4
TEMPERATURE=0.1
```

### Configuration Classes
```python
@dataclass
class APIConfig:
    openai_api_key: str
    alpha_vantage_key: str
    openai_model: str = "gpt-4"
    max_tokens: int = 1000
    temperature: float = 0.7

@dataclass  
class AppConfig:
    api: APIConfig
    vector_db: VectorDBConfig
    cache: CacheConfig
    debug: bool = False
```

## Coding Standards & Patterns

### Import Organization
```python
# Standard library imports first
from typing import Dict, Any, List, Optional
from datetime import datetime, timedelta

# Third-party imports
import pandas as pd
import numpy as np
from langchain.llms.base import LLM

# Local imports last
from src.agents.base_agent import BaseFinanceAgent
from src.core.state import FinanceAssistantState
```

### Error Handling Pattern
```python
def execute(self, state: FinanceAssistantState) -> Dict[str, Any]:
    try:
        # Main logic here
        return self.format_response(response, sources)
    except Exception as e:
        self.logger.error(f"Error in {self.agent_name}: {str(e)}")
        return self.handle_error(e, "execution context")
```

### Agent Communication Pattern
```python
def _suggest_next_agent(self, query: str) -> Optional[str]:
    """Suggest which agent should handle follow-up queries"""
    if "portfolio" in query.lower():
        return "portfolio_agent"
    elif "market" in query.lower() or "stock" in query.lower():
        return "market_agent"
    elif "goal" in query.lower() or "retirement" in query.lower():
        return "goal_agent"
    return None
```

## Testing Patterns

### Test Structure
```python
# tests/test_agents/test_finance_qa_agent.py
class TestFinanceQAAgent:
    @pytest.fixture
    def mock_llm(self):
        return Mock(spec=LLM)
    
    @pytest.fixture  
    def finance_qa_agent(self, mock_llm):
        return FinanceQAAgent(llm=mock_llm, tools=[], agent_name="test")
    
    def test_execute_basic_query(self, finance_qa_agent):
        # Test implementation
```

### Running Tests
```bash
# Run all tests with coverage
poetry run pytest tests/ -v --cov=src --cov-report=html

# Run specific test file
poetry run pytest tests/test_agents/test_finance_qa_agent.py -v

# Run with specific markers
poetry run pytest -m "not integration" -v
```

## Development Workflow

### Poetry Commands
```bash
# Install dependencies
poetry install

# Run application
poetry run streamlit run src/web_app/main.py

# Run tests
poetry run pytest

# Add new dependency
poetry add package-name

# Development dependency
poetry add --group dev package-name
```

### File Naming Conventions
- **Agents**: `{purpose}_agent.py` (e.g., `finance_qa_agent.py`)
- **Tests**: `test_{module_name}.py` (e.g., `test_finance_qa_agent.py`) 
- **Utilities**: `{purpose}_calc.py` or `{purpose}_utils.py`
- **Web UI**: `{purpose}_tab.py` for Streamlit tabs

## Common Implementation Patterns

### RAG Integration
```python
def _get_relevant_context(self, query: str) -> List[str]:
    """Retrieve relevant documents from knowledge base"""
    retriever = FinanceRetriever()
    docs = retriever.get_relevant_documents(query, k=5)
    return [doc.page_content for doc in docs]
```

### Market Data Caching
```python
def _get_cached_data(self, symbol: str) -> Optional[Dict]:
    """Get cached market data with TTL check"""
    cache_key = f"market_data_{symbol}"
    if cache_key in self.cache:
        data, timestamp = self.cache[cache_key]
        if datetime.now() - timestamp < timedelta(minutes=30):
            return data
    return None
```

### Response Formatting
```python
def format_response(self, content: str, sources: List[str] = None) -> Dict[str, Any]:
    """Standard response formatting across all agents"""
    return {
        "agent_response": content,
        "sources": sources or [],
        "confidence": self._calculate_confidence(content),
        "next_agent": self._suggest_next_agent(content),
        "updated_context": {}
    }
```

## API Integration Examples

### OpenAI LLM Usage
```python
from langchain.llms import OpenAI

llm = OpenAI(
    model_name="gpt-4",
    temperature=0.1,
    max_tokens=1000
)

response = llm.predict(prompt_template.format(query=query, context=context))
```

### Alpha Vantage Market Data
```python
def fetch_stock_data(self, symbol: str) -> Dict[str, Any]:
    """Fetch stock data from Alpha Vantage API"""
    url = f"https://www.alphavantage.co/query"
    params = {
        "function": "TIME_SERIES_DAILY",
        "symbol": symbol,
        "apikey": self.api_key
    }
    response = requests.get(url, params=params)
    return response.json()
```

## Streamlit UI Patterns

### Tab Structure
```python
# src/web_app/main.py
def main():
    st.set_page_config(page_title="AI Finance Assistant", layout="wide")
    
    tab1, tab2, tab3, tab4 = st.tabs(["Chat", "Portfolio", "Market", "Goals"])
    
    with tab1:
        render_chat_tab()
    with tab2:
        render_portfolio_tab()
    # etc.
```

### Session State Management
```python
# Initialize session state
if "conversation_history" not in st.session_state:
    st.session_state.conversation_history = []

if "current_agent" not in st.session_state:
    st.session_state.current_agent = "finance_qa"
```

## Performance & Optimization

### Vector Store Optimization
- Use FAISS for efficient similarity search
- Implement document chunking with 500-1000 character chunks
- Cache embeddings to avoid repeated API calls

### API Rate Limiting
- Implement exponential backoff for API failures
- Cache market data for 30 minutes
- Use request queuing for high-volume scenarios

### Memory Management
- Limit conversation history to last 10 interactions
- Implement LRU cache for frequently accessed data
- Clear vector store cache periodically

## Common Issues & Solutions

### Import Errors
- Always use absolute imports from `src.` prefix
- Check for circular imports between modules
- Ensure `__init__.py` files exist in all packages

### Agent Communication
- Use the standardized response format for agent chaining
- Implement proper error handling in agent execution
- Log agent transitions for debugging

### API Key Management
- Never commit API keys to version control
- Use `.env` files for local development
- Validate API keys on application startup

This context file should help GitHub Copilot provide more accurate and consistent suggestions for your AI Finance Assistant project.
